
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Casino Slot Machine Experiment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: radial-gradient(circle at 50% 20%, #2d1a09 0%, #1a0d04 100%); color: #eee; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .hidden { display: none !important; }
    .center { text-align: center; }
    .slot-machine-layout { display: flex; flex-direction: row; gap: 32px; align-items: flex-start; }
    .slot-machine { background: linear-gradient(135deg, #3b1e00 60%, #a67c52 100%); border-radius: 24px; padding: 32px 24px 24px 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); margin-bottom: 24px; flex: 3; position: relative;}
    .slot-machine::before {
      content: ""; position: absolute; left: 0; top: 0; width: 100%; height: 100%;
      background: repeating-linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05) 20px, transparent 40px, transparent 60px);
      border-radius: 24px; pointer-events: none;
    }
    .reels { display: flex; justify-content: center; gap: 24px; margin-bottom: 20px; }
    .reel {
      width: 140px; height: 140px; background: radial-gradient(circle, #fffbe6 60%, #f1c40f 100%);
      border: 6px solid #bfa145; border-radius: 16px; display: flex; align-items: center; justify-content: center;
      font-size: 5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.6), 0 0 24px rgba(255,247,0,0.4) inset;
      transition: box-shadow 0.2s;
    }
    .reels.sparkle .reel {
      box-shadow: 0 0 32px #fff700, 0 0 48px rgba(255,247,0,0.6), 0 0 24px rgba(255,247,0,0.4) inset;
      animation: sparkle-reel 0.4s alternate infinite;
    }
    @keyframes sparkle-reel {
      0% { box-shadow: 0 0 32px #fff700, 0 0 48px rgba(255,247,0,0.6), 0 0 24px rgba(255,247,0,0.4) inset; }
      100% { box-shadow: 0 0 64px #fff700, 0 0 96px rgba(255,247,0,0.8), 0 0 48px rgba(255,247,0,0.6) inset; }
    }
    .chips { display: flex; justify-content: center; gap: 18px; margin-bottom: 18px; }
    .chip {
      width: 56px; height: 56px; border-radius: 50%; background: radial-gradient(circle, #ffe066 60%, #e1b700 100%);
      border: 4px solid #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.3rem; cursor: pointer; transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
      position: relative;
      margin: 0 2px;
      color: #542d0a; /* Color for the numbers on the chips */
    }
    .chip.selected { border: 4px solid #ff3; box-shadow: 0 0 16px #fff700; }
    .shape-chip svg { width: 40px; height: 40px; }
    .spin-btn {
      background: linear-gradient(90deg, #ff2d2d 60%, #ffb300 100%);
      color: #fff; padding: 16px 40px; border: none; border-radius: 12px; font-size: 1.5rem; cursor: pointer; margin-bottom: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 0 16px rgba(255,247,0,0.33);
      font-family: 'Segoe UI', Arial, sans-serif;
      font-weight: bold;
      letter-spacing: 1px;
      transition: filter 0.2s;
    }
    .spin-btn:disabled { background: #888; filter: grayscale(0.5); }
    .total-winnings, .wallet {
      background: #222; color: #ffd700; font-size: 1.3rem; padding: 8px 32px; border-radius: 10px; margin: 0 auto 16px auto; display: inline-block; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      text-shadow: 0 0 6px #fff700;
    }
    .wallet { color: #00ffae; margin-left: 16px; }
    .message { font-size: 1.25rem; margin: 14px 0; min-height: 40px;}
    .social { color: #0f0; font-weight: bold; }
    .nogain { color: #aaa; }
    .win-amount { color: #ffd700; font-weight: bold; font-size: 1.2rem; text-shadow: 0 0 8px #fff700; }
    .instructions, .memoryForm, .probe, .consent, .affectiveForm, .participantForm, .baselineScreen, .likedShapesForm { background: #222; border-radius: 16px; padding: 32px 24px; margin-bottom: 28px; }
    .question { margin-bottom: 18px; }
    .leaderboard { background: #1a1203; border-radius: 16px; padding: 18px 16px; max-width: 260px; margin: 0; box-shadow: 0 2px 12px rgba(0,0,0,0.6); flex: 1;}
    .leaderboard h3 { margin: 0 0 10px 0; color: #ffd700; text-align: center; letter-spacing: 1px; }
    .leaderboard-list { list-style: none; padding: 0; margin: 0; }
    .leaderboard-list li { padding: 6px 0; font-size: 1.1rem; }
    .player { color: #fff700; font-weight: bold; background: #3b2e00; border-radius: 6px; padding: 2px 8px;}
    .sparkle-text {
      animation: sparkle-text 0.7s alternate infinite;
      text-shadow: 0 0 12px #fff700, 0 0 24px rgba(255,247,0,0.6);
    }
    @keyframes sparkle-text {
      0% { text-shadow: 0 0 12px #fff700, 0 0 24px rgba(255,247,0,0.6); }
      100% { text-shadow: 0 0 32px #fff700, 0 0 48px rgba(255,247,0,0.8); }
    }
    .reels-bg { background: repeating-linear-gradient(135deg, rgba(255,215,0,0.13) 0 8px, rgba(255,240,0,0) 8px 16px); border-radius: 20px;
      padding: 10px; margin-bottom: 10px; position: relative;
    }
    .coin-shower .coin {
      position: absolute; width: 28px; height: 28px; pointer-events: none;
      background: radial-gradient(circle, #ffe066 60%, #e1b700 100%);
      border-radius: 50%; border: 2px solid #fff;
      animation: coin-fall 1.1s cubic-bezier(.4,1.5,.7,1.1) forwards;
      z-index: 10;
    }
    @keyframes coin-fall {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(180px) scale(1.3); opacity: 0; }
    }
    .thumbs-down { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); font-size: 4rem; color: #ff2d2d; z-index: 20; }
    .thumbs-down.hidden { display: none !important; }
    .liked-symbols-list {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
      margin: 18px 0;
    }
    .liked-symbol-opt {
      border: 2px solid #444;
      border-radius: 10px;
      padding: 6px;
      background: #222;
      cursor: pointer;
      transition: border 0.2s, background 0.2s;
      width: 88px;
      height: 88px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .liked-symbol-opt.selected {
      border: 2px solid #0f0;
      background: #333;
      box-shadow: 0 0 12px #0f0, 0 0 24px rgba(0,255,0,0.5);
    }
    @media (max-width: 900px) {
      .slot-machine-layout { flex-direction: column; }
      .leaderboard { max-width: 100%; margin-top: 24px;}
    }
    .symbol-opt svg, .probe-btn svg, .reel svg, .shape-chip svg {
      width: 72px;
      height: 72px;
      display: block;
      margin: 0 auto;
    }
    .symbols-list { display: flex; gap: 16px; margin-top: 8px; }
    .symbol-opt { border: 2px solid #666; border-radius: 8px; padding: 6px; background: #222; cursor: pointer; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;}
    .symbol-opt.selected { border: 2px solid #0f0; background: #444; }
    .probe-pair { display: flex; gap: 32px; justify-content: center; margin: 18px 0; }
    .probe-btn { border: 2px solid #888; background: #222; border-radius: 8px; padding: 8px; cursor: pointer; width: 80px; height: 80px; }
    .probe-btn.selected { border: 2px solid #0f0; }
    button, .submit-btn { padding: 8px 18px; border-radius: 6px; border: none; background: #0a8; color: #fff; font-weight: bold; cursor: pointer; }
    .skip-btn { background-color: #555; margin-left: 10px; }
  </style>
</head>
<body>
<div class="container">

  <form class="consent" id="consentForm">
  <h2>INFORMED CONSENT FORM</h2>
  <div style="margin-bottom:10px;">
    <b>Title of Study:</b><br>
    Exploring the effectiveness of novel protocol on reinstatement of appetitive memory
  </div>
  <div style="margin-bottom:10px;">
    <b>Principal Investigator:</b><br>
    Riya Sharma<br>
    Rekhi Centre of Excellence for the Science of Happiness<br>
    IIT Kharagpur<br>
    8194006406
  </div>
  <div style="margin-bottom:10px;">
    <b>Introduction</b><br>
    You are invited to take part in a research study about  people respond to different types of images and tasks related to card games. Please read this form carefully and ask any questions you may have before agreeing to participate.
  </div>
  <div style="margin-bottom:10px;">
    <b>Purpose of the Study</b><br>
    The purpose of this research is to better understand  people process and respond to certain experiences and tasks involving games, feedback, and brief physiological activities. The results may help us learn more about memory, emotion, and reinstatement in everyday life.
  </div>
  <div style="margin-bottom:10px;">
    <b>Procedures</b>
    <ul>
      <li>You will attend three sessions on three different days.</li>
      <li>You will play a computerized slot machine game, complete breathing and feedback tasks, and respond to a series of images and questions on a computer.</li>
      <li>During some parts of the study, you may be asked to briefly immerse your hand in cool water.</li>
      <li>Your physiological responses (such as skin conductance and heart rate) may be measured at certain times.</li>
      <li>The total time commitment is approximately 30‚Äì90 minutes across all sessions.</li>
    </ul>
    Some details about the specific tasks are not described here to ensure the scientific validity of the study. All procedures are designed to be safe for healthy adults. You will receive a full explanation of the study‚Äôs purpose and procedures at the end of your participation (debriefing).
  </div>
  <div style="margin-bottom:10px;">
    <b>Risks and Discomforts</b>
    <ul>
      <li>You may experience mild discomfort from the cool water task, which is brief and can be stopped at any time.</li>
      <li>Some participants may find certain feedback or tasks mildly frustrating or emotionally activating.</li>
      <li>Please inform the researcher if you have a history of heart problems, Raynaud‚Äôs disease, or sensitivity to cold.</li>
      <li>You may withdraw from the study at any time without penalty.</li>
    </ul>
  </div>
  <div style="margin-bottom:10px;">
    <b>Benefits</b>
    <ul>
      <li>There is no direct benefit to you, but your participation will help advance scientific knowledge about memory and decision-making.</li>
    </ul>
  </div>
  <div style="margin-bottom:10px;">
    <b>Confidentiality</b>
    <ul>
      <li>All information collected will be kept strictly confidential. Your data will be coded with a number, not your name.</li>
      <li>Only the research team will have access to the data.</li>
      <li>Results may be published in scientific journals, but no identifying information will be included.</li>
    </ul>
  </div>
  <div style="margin-bottom:10px;">
    <b>Voluntary Participation</b>
    <ul>
      <li>Your participation is voluntary. You may refuse to participate or withdraw at any time, without penalty or loss of benefits to which you are otherwise entitled.</li>
      <li>You may skip any question or task that makes you uncomfortable.</li>
    </ul>
  </div>
  <div style="margin-bottom:10px;">
    <b>Questions</b><br>
    If you have questions about this study, please contact:<br>
    Riya Sharma, 8194006406
  </div>
  <div style="margin-bottom:10px;">
    <b>Debriefing</b><br>
    At the end of your participation, you will receive a complete explanation of the study‚Äôs purpose, procedures, and any information that was not disclosed before or during the study. You will have the opportunity to ask questions, and, if you wish, you may request that your data be withdrawn after learning the full details.
  </div>
  <div style="margin-bottom:10px;">
    <b>CONSENT</b><br>
    I have read and understood the information above. I have had the opportunity to ask questions and have received satisfactory answers. I voluntarily agree to participate in this study.
  </div>
  <label>
    <input type="checkbox" id="consentCheck" required>
    I have read the information above and consent to participate.
  </label>
  <br><br>
  <button class="submit-btn" type="submit">Continue</button>
</form>


  <form class="participantForm hidden" id="participantForm">
    <h2>Participant Information</h2>
    <div class="question"><label>Participant ID: <input type="text" id="participantId" required></label></div>
    <div class="question"><label>Session ID: <input type="text" id="sessionId" required></label></div>
    <div class="question"><label>Group Number: <input type="number" id="groupNumber" required min="1"></label></div>
    <div class="question"><label>Name: <input type="text" id="name" required></label></div>
    <div class="question"><label>Age: <input type="number" id="age" required min="18" max="99"></label></div>
    <div class="question"><label>Gender:
      <select id="gender" required>
        <option value="">Select...</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
    </label></div>
    <button class="submit-btn" type="submit">Continue</button>
    <button class="submit-btn skip-btn" type="button" id="skipParticipantForm">Skip</button>
  </form>

  <div class="baselineScreen hidden" id="baselineScreen">
        <h2>Baseline Recording</h2>
        <p>Please sit still and relax for the next 2 minutes. Focus on the crosshair on the screen.</p>
        <div class="center" style="font-size: 5rem; margin: 20px 0;">+</div>
        <p>Time remaining: <span id="baselineTimer">120</span> seconds</p>
        <button class="submit-btn skip-btn" type="button" id="skipBaseline">Skip</button>
    </div>

  <form class="likedShapesForm hidden" id="likedShapesForm">
    <h2>Shape Preferences</h2>
    <div class="question">
      <label>Please mark all the shapes that you like:</label>
      <div class="liked-symbols-list" id="likedSymbolsList"></div>
    </div>
    <div id="likedShapesError" style="color:#ff7070; margin-bottom:10px; display:none;"></div>
    <button class="submit-btn" type="submit">Continue</button>
    <button class="submit-btn skip-btn" type="button" id="skipLikedShapes">Skip</button>
  </form>


  <div class="instructions hidden" id="instructions">
    <h2>Welcome to the Casino Slot Machine Game!</h2>
    <ul>
      <li>You will play <b>50 rounds</b>. In each round, place your bet using casino chips, and choose a shape to bet on.</li>
      <li><b>Higher the bet, higher the risk and potential reward.</b></li>
      <li>Try to climb the leaderboard by winning more!</li>
      <li>Press the <b>SPIN</b> button to play each round.</li>
      <li>You start with <b>$2000</b> in your wallet. If you run out, you can't play further.</li>
      <li>Good luck!</li>
    </ul>
    <button class="submit-btn">Start Game</button>
    <button class="submit-btn skip-btn" type="button" id="skipInstructions">Skip</button>
  </div>

  <div class="slot-machine-layout hidden" id="gameLayout">
    <div id="game" class="slot-machine">
      <div class="center">
        <h2>Slot Machine Game</h2>
        <div id="trialInfo"></div>
      </div>
      <div>
        <span class="total-winnings" id="totalWinnings">Total Winnings: $0</span>
        <span class="wallet" id="walletDisplay">Wallet: $2000</span>
      </div>
      <div class="reels-bg" style="position:relative;">
        <div class="reels" id="reels"></div>
        <div class="coin-shower" id="coinShower"></div>
        <div class="thumbs-down hidden" id="thumbsDown"></div>
      </div>
      <div class="chips" id="chips">
        <div class="chip" data-value="1">$1</div>
        <div class="chip" data-value="5">$5</div>
        <div class="chip" data-value="10">$10</div>
        <div class="chip" data-value="20">$20</div>
      </div>
      <div class="chips" id="shapeChips" style="margin-bottom:18px;">
        <div class="chip shape-chip" data-shape="sphere" title="Bet on Sphere"></div>
        <div class="chip shape-chip" data-shape="cube" title="Bet on Cube"></div>
        <div class="chip shape-chip" data-shape="pyramid" title="Bet on Pyramid"></div>
        <div class="chip shape-chip" data-shape="cylinder" title="Bet on Cylinder"></div>
      </div>
      <div class="center message" id="gameMessage"></div>
      <div class="center" style="margin-top:10px;">
        <button class="spin-btn" id="spinBtn" onclick="spin()">SPIN</button>
        <button class="submit-btn skip-btn" type="button" id="skipGame">Skip Game</button>
      </div>
    </div>
    <div class="leaderboard" id="leaderboard">
      <h3>Leaderboard</h3>
      <ol class="leaderboard-list" id="leaderboardList"></ol>
    </div>
  </div>

 <form class="affectiveForm hidden" id="affectiveForm">
    <h2>Affective Ratings</h2>
    <div class="affective-layout">
      <div class="affective-left">
        <div class="affective-instructions">
          Please rate the question using <b>BOTH the sliders</b> .<br>
        </div>
        <div class="affective-slider-block">
          <div class="affective-slider-label">
            <img src="https://img.icons8.com/emoji/48/000000/crying-face.png" class="affective-slider-face" alt="Sad">
            <input type="range" min="1" max="9" value="5" class="affective-slider" id="valenceSlider">
            <img src="https://em-content.zobj.net/thumbs/240/apple/354/grinning-face_1f600.png" alt="Happy Emoji" width="42" height="42">
          </div>
          <div class="affective-slider-caption">‚ÄúRate the level of pleasantness or unpleasantness while playing the game by using the slider  The scale ranges from extremely unpleasant (represented by the frowning figure on the far left) to extremely pleasant (represented by the smiling figure on the far right). The middle of the scale represents a neutral feeling.‚Äù</b></div>
        </div>

        <div class="affective-slider-block">
          <div class="affective-slider-label">
            <img src="https://img.icons8.com/emoji/48/000000/sleeping-face.png" class="affective-slider-face" alt="Low arousal">
            <input type="range" min="1" max="9" value="5" class="affective-slider" id="arousalSlider">
            <img src="https://img.icons8.com/emoji/48/000000/astonished-face.png" class="affective-slider-face" alt="High arousal">
          </div>
          <div class="affective-slider-caption">‚ÄúHow intense or calm do you feel while playing the slot machine game by using the slider. The scale ranges from  a very low level of arousal (feeling completely calm, relaxed, or sleepy) to very high level of arousal (feeling excited, agitated, frenzied, or wide awake). ‚Äù</b></div>
        </div>
        <button class="submit-btn" type="submit">Continue</button>
        <button class="submit-btn skip-btn" type="button" id="skipAffectiveForm">Skip</button>
      </div>
      <div>
      </div>
    </div>
  </form>


  <form class="memoryForm hidden" id="memoryForm">
    <h2>Memory and Awareness</h2>
    <div class="question">
      <label>Please mark all the shapes present in slot machine game (you can also mark if your response is 'maybe'):</label>
      <div class="symbols-list" id="memorySymbolsList"></div>
    </div>
    <div class="question">
      <label>Please mark all the shapes that leads you to win:</label>
      <div class="symbols-list" id="contingencySymbolsList"></div>
    </div>
    <button class="submit-btn" type="submit">Continue</button>
    <button class="submit-btn skip-btn" type="button" id="skipMemoryForm">Skip</button>
  </form>

  <div class="probe hidden" id="probeTask">
    <h2>Binary Probe Task</h2>
    <div id="probePairs"></div>
    <button class="submit-btn" id="finishBtn" disabled>Finish</button>
    <button class="submit-btn skip-btn" type="button" id="skipProbeTask">Skip</button>
  </div>

  <div class="center hidden" id="thankYou">
    <h2>Thank you for participating!</h2>
    <p>Your responses have been recorded.</p>
    <div class="footer">Casino Slot Machine Experiment &copy; 2025</div>
  </div>
</div>

  <audio id="winSound" src="https://orangefreesounds.com/wp-content/uploads/2022/06/Casino-winner-sound-effect.mp3"></audio>

</div>
<script>
/* --- Sound Helper --- */
const winSound = document.getElementById('winSound');
function playAudioFor2Seconds(audioElement) {
  if (!audioElement) return;
  audioElement.currentTime = 0;
  audioElement.play();
  setTimeout(() => {
    audioElement.pause();
    audioElement.currentTime = 0;
  }, 2000);
}

// --- 3D SVG SHAPES ---
const shapeSVGs = {
  'sphere': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><radialGradient id="g1" cx="50%" cy="40%" r="50%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#a3f"/></radialGradient></defs><ellipse cx="40" cy="40" rx="32" ry="32" fill="url(#g1)" stroke="#5c2a7c" stroke-width="4"/></svg>`,
  'cube': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#3a6"/></linearGradient></defs><rect x="16" y="16" width="48" height="48" rx="8" fill="url(#g2)" stroke="#2a7c5c" stroke-width="4"/></svg>`,
  'pyramid': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g3" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#a3f"/></linearGradient></defs><polygon points="40,12 68,68 12,68" fill="url(#g3)" stroke="#5c2a7c" stroke-width="4"/></svg>`,
  'cylinder': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#3a6"/></linearGradient></defs><ellipse cx="40" cy="20" rx="24" ry="10" fill="#fff" opacity="0.5"/><rect x="16" y="20" width="48" height="40" rx="24" fill="url(#g4)" stroke="#2a7c5c" stroke-width="4"/><ellipse cx="40" cy="60" rx="24" ry="10" fill="#3a6" stroke="#2a7c7c" stroke-width="4"/></svg>`,
  'hexPrism': `<svg width="40" height="40" viewBox="0 0 80 80"><polygon points="20,30 40,12 60,30 60,50 40,68 20,50" fill="#fa3" stroke="#fa3" stroke-width="4"/></svg>`,
  'starPrism': `<svg width="40" height="40" viewBox="0 0 80 80"><polygon points="40,12 47,32 68,32 51,46 57,66 40,54 23,66 29,46 12,32 33,32" fill="#fa3" stroke="#fa3" stroke-width="4"/></svg>`,
  'capsule': `<svg width="40" height="40" viewBox="0 0 80 80"><rect x="20" y="24" width="40" height="32" rx="20" fill="#fff" stroke="#fa3" stroke-width="4"/><ellipse cx="40" cy="24" rx="20" ry="12" fill="#fa3"/><ellipse cx="40" cy="56" rx="20" ry="12" fill="#fa3"/></svg>`
};
const allSymbols = ['sphere', 'cube', 'pyramid', 'cylinder'];
const winningCombos = [['sphere','sphere','sphere'], ['pyramid','pyramid','pyramid']];
const nogainCombos = [['cube','cylinder','cube'], ['cylinder','cube','cylinder']]; // Updated as per logic, though not directly used in spin()
const distractorSymbols = ['hexPrism', 'starPrism', 'capsule'];
const rewardSymbols = ['sphere', 'pyramid'];

let participant = {
  participantId: '', sessionId: '', groupNumber: '',
  name: '', age: '', gender: '',
  likedShapes: [],

  trials: [],
  totalWinnings: 0,
  timestamps: {
      experimentStart: new Date().toISOString(),
      consentStart: new Date().toISOString(),
      consentEnd: null,
      participantInfoStart: null,
      participantInfoEnd: null,
      baselineStart: null,
      baselineEnd: null,
      preferenceTaskStart: null,
      preferenceTaskEnd: null,

      slotMachineStart: null,
      slotMachineEnd: null,
      affectiveTaskStart: null,
      affectiveTaskEnd: null,
      memoryContingencyStart: null,
      memoryContingencyEnd: null,
      probeTaskStart: null,
      probeTaskEnd: null,
      experimentEnd: null
  }
};

let trialOrder = [];
let trialNum = 0;
let betAmount = 1;
let betShape = 'sphere';
let leaderboard = [];
let totalWinnings = 0;
let wallet = 2000;
let winCount = 0;

// --- Task Flow Functions ---

// Helper to hide all task screens
function hideAllTasks() {
  document.querySelectorAll('.container > *').forEach(el => {
    if (el.id !== 'thankYou') el.classList.add('hidden');
  });
}

// 1. Consent Form
function showParticipantForm() {
  participant.timestamps.consentEnd = new Date().toISOString();
  participant.timestamps.participantInfoStart = new Date().toISOString();
  hideAllTasks();
  document.getElementById('participantForm').classList.remove('hidden');
}

// 2. Participant Info & Baseline
function startBaseline() {
    // Gather participant data
    participant.participantId = document.getElementById('participantId').value.trim();
    participant.sessionId = document.getElementById('sessionId').value.trim();
    participant.groupNumber = document.getElementById('groupNumber').value;
    participant.name = document.getElementById('name').value.trim();
    participant.age = document.getElementById('age').value;
    participant.gender = document.getElementById('gender').value;

    // Record timestamps
    participant.timestamps.participantInfoEnd = new Date().toISOString();
    participant.timestamps.baselineStart = new Date().toISOString();

    // Show baseline screen and start timer
    hideAllTasks();
    document.getElementById('baselineScreen').classList.remove('hidden');

    let timeLeft = 120;
    const timerEl = document.getElementById('baselineTimer');
    timerEl.textContent = timeLeft;

    // Clear any existing interval before starting a new one
    if (window.baselineTimerInterval) {
        clearInterval(window.baselineTimerInterval);
    }

    window.baselineTimerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(window.baselineTimerInterval);
            participant.timestamps.baselineEnd = new Date().toISOString();
            hideAllTasks();
            showLikedShapes(); // Proceed to the next task
        }
    }, 1000);
}

function skipBaseline() {
    if (window.baselineTimerInterval) {
        clearInterval(window.baselineTimerInterval);
    }
    participant.timestamps.baselineEnd = new Date().toISOString();
    hideAllTasks();
    showLikedShapes();
}


// 3. Preference Task (Liked Shapes)
function showLikedShapes() {
  participant.timestamps.preferenceTaskStart = new Date().toISOString();
  hideAllTasks();
  document.getElementById('likedShapesForm').classList.remove('hidden');
  renderLikedShapes();
}
function renderLikedShapes() {
  const list = document.getElementById('likedSymbolsList');
  list.innerHTML = '';
  // participant.likedShapes = []; // Keep previous selections if any
  allSymbols.forEach(sym => {
    const div = document.createElement('div');
    div.className = 'liked-symbol-opt';
    if (participant.likedShapes.includes(sym)) {
        div.classList.add('selected');
    }
    div.innerHTML = shapeSVGs[sym] || '';
    div.onclick = function() {
      div.classList.toggle('selected');
      const index = participant.likedShapes.indexOf(sym);
      if (div.classList.contains('selected')) {
        if (index === -1) participant.likedShapes.push(sym);
      } else {
        if (index > -1) participant.likedShapes.splice(index, 1);
      }
    };
    list.appendChild(div);
  });
}
function validateLikedShapes() {
  if (participant.likedShapes.length === 0) {
    document.getElementById('likedShapesError').innerText = "Please select at least one shape you like.";
    document.getElementById('likedShapesError').style.display = "block";
    return false;
  }
  participant.timestamps.preferenceTaskEnd = new Date().toISOString();
  document.getElementById('likedShapesError').style.display = "none";
  hideAllTasks();
  showInstructions(); // Proceed directly to instructions after liked shapes
  return true;
}
function skipLikedShapes() {
  participant.timestamps.preferenceTaskEnd = new Date().toISOString();
  participant.likedShapes = []; // Clear selections if skipped
  hideAllTasks();
  showInstructions();
}

// 4. Instructions (formerly after BIS-BAS)
function showInstructions() {
  hideAllTasks();
  document.getElementById('instructions').classList.remove('hidden');
}
function skipInstructions() {
  // Assuming game starts immediately after instructions when not skipped
  startGame();
}


// 5. Slot Machine Game
function generateTrialOrder() {
  const TOTAL_TRIALS = 50, NOGAIN_TRIALS = Math.round(TOTAL_TRIALS * 0.3);
  let order = Array(TOTAL_TRIALS).fill('win');
  for (let i = 0; i < 4; i++) order[i] = 'win';
  for (let i = TOTAL_TRIALS - 4; i < TOTAL_TRIALS; i++) order[i] = 'win';
  let nogainIndices = [];
  while (nogainIndices.length < NOGAIN_TRIALS) {
    let idx = Math.floor(Math.random() * (TOTAL_TRIALS - 8)) + 4;
    if (!nogainIndices.includes(idx)) nogainIndices.push(idx);
  }
  nogainIndices.forEach(idx => order[idx] = 'nogain');
  return order;
}
function startGame() {
  participant.timestamps.slotMachineStart = new Date().toISOString();
  trialOrder = generateTrialOrder();
  trialNum = 0;
  totalWinnings = 0;
  participant.trials = [];
  participant.totalWinnings = 0;
  wallet = 2000;
  winCount = 0;
  leaderboard = Array.from({length: 15}, (_,i) => ({
    name: "Player " + (i+1), score: Math.floor(Math.random()*200+50)
  }));
  leaderboard.push({name: participant.name || "You", score: 0});
  hideAllTasks();
  document.getElementById('gameLayout').classList.remove('hidden');
  updateGameUI();
  renderLeaderboard();
  // Money chip selection
  document.querySelectorAll('.chip').forEach(chip => {
    if (!chip.classList.contains('shape-chip')) {
      chip.onclick = function() {
        document.querySelectorAll('.chip').forEach(c => { if (!c.classList.contains('shape-chip')) c.classList.remove('selected'); });
        chip.classList.add('selected');
        betAmount = parseInt(chip.dataset.value);
        if (wallet < betAmount) {
          document.getElementById('spinBtn').disabled = true;
          document.getElementById('gameMessage').innerHTML = `<span class="nogain">Insufficient funds to bet. Game over!</span>`;
        } else {
          document.getElementById('spinBtn').disabled = false;
          document.getElementById('gameMessage').innerHTML = '';
        }
      }
    }
  });
  // Shape chip selection
  renderShapeChips();
}
function renderShapeChips() {
  const chips = document.querySelectorAll('.shape-chip');
  chips.forEach(chip => {
    const shape = chip.dataset.shape;
    chip.innerHTML = shapeSVGs[shape];
    chip.onclick = function() {
      chips.forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
      betShape = shape;
    }
  });
  chips[0].classList.add('selected');
  betShape = chips[0].dataset.shape;
}
function updateGameUI() {
  document.getElementById('trialInfo').innerHTML = `<b>Trial ${trialNum+1} of 50</b>`;
  renderReels(['sphere','cube','pyramid']); // Default symbols for display
  document.getElementById('gameMessage').innerHTML = '';
  document.getElementById('spinBtn').disabled = false;
  document.getElementById('totalWinnings').innerText = `Total Winnings: $${totalWinnings}`;
  document.getElementById('walletDisplay').innerText = `Wallet: $${wallet}`;
  document.querySelectorAll('.chip').forEach(chip => { if (!chip.classList.contains('shape-chip')) chip.classList.remove('selected'); });
  betAmount = 1;
  document.querySelector('.chip[data-value="1"]').classList.add('selected');
  document.getElementById('reels').classList.remove('sparkle');
  if (wallet < betAmount) {
    document.getElementById('spinBtn').disabled = true;
    document.getElementById('gameMessage').innerHTML = `<span class="nogain">Insufficient funds to bet. Game over!</span>`;
  }
}
function renderReels(symbols) {
  const reelsDiv = document.getElementById('reels');
  reelsDiv.innerHTML = '';
  symbols.forEach(sym => {
    const div = document.createElement('div');
    div.className = 'reel';
    div.innerHTML = shapeSVGs[sym] || '';
    reelsDiv.appendChild(div);
  });
}
function renderLeaderboard() {
  let player = leaderboard[leaderboard.length-1];
  let others = leaderboard.slice(0, leaderboard.length-1);
  others.sort((a,b) => b.score - a.score);
  let idx = others.findIndex(l => l.score <= player.score);
  if (idx === -1) idx = others.length;
  let displayList = others.slice(0, idx).concat([player], others.slice(idx));
  for (let i=0; i<displayList.length; ++i) {
    if (displayList[i] === player) continue;
    if (i < displayList.indexOf(player)) {
      displayList[i].score = Math.max(displayList[i].score, player.score+1);
    } else {
      displayList[i].score = Math.min(displayList[i].score, player.score-1);
    }
  }
  const list = document.getElementById('leaderboardList');
  list.innerHTML = '';
  displayList.forEach((l,i) => {
    const li = document.createElement('li');
    li.innerText = l.name + " - $" + l.score;
    if (l.name === player.name) li.className = 'player';
    list.appendChild(li);
  });
}
function coinShower() {
  const shower = document.getElementById('coinShower');
  shower.innerHTML = '';
  for (let i=0;i<16;i++) {
    const coin = document.createElement('div');
    coin.className = 'coin';
    coin.style.left = (10 + Math.random()*80) + '%';
    coin.style.top = (-10 + Math.random()*20) + 'px';
    coin.style.animationDelay = (Math.random()*0.5) + 's';
    shower.appendChild(coin);
  }
  setTimeout(()=>{shower.innerHTML='';}, 1200);
  playAudioFor2Seconds(document.getElementById('winSound'));
}
function thumbsDown() {
  const td = document.getElementById('thumbsDown');
  td.classList.remove('hidden');
  setTimeout(()=>{ td.classList.add('hidden'); }, 1000);
}

// --- PREVIOUSLY MODIFIED FUNCTION (No changes needed here) ---
function spin() {
    if (wallet < betAmount) {
        document.getElementById('gameMessage').innerHTML = `<span class="nogain">Insufficient funds to bet. Game over!</span>`;
        document.getElementById('spinBtn').disabled = true;
        return;
    }
    document.getElementById('spinBtn').disabled = true;
    let spinStart = Date.now();
    wallet -= betAmount; // Bet is initially deducted
    document.getElementById('walletDisplay').innerText = `Wallet: $${wallet}`;

    let anim = setInterval(() => {
        renderReels([
            allSymbols[Math.floor(Math.random() * allSymbols.length)],
            allSymbols[Math.floor(Math.random() * allSymbols.length)],
            allSymbols[Math.floor(Math.random() * allSymbols.length)]
        ]);
    }, 70);

    setTimeout(() => {
        clearInterval(anim);

        let outcome;
        let combo, winAmount = 0, message = '', isReward = 0;
        const winningShapes = ['sphere', 'pyramid'];

        if (winningShapes.includes(betShape)) {
            // WIN condition: User bet on a winning shape
            outcome = 'win';
            combo = [betShape, betShape, betShape];
            winAmount = betAmount * 2;
            totalWinnings += winAmount;
            participant.totalWinnings = totalWinnings;
            wallet += winAmount; // Add winnings
            message = `<span class="sparkle-text">üéâ You win <span class="win-amount">$${winAmount}</span>!</span>`;
            isReward = 1;
            coinShower();
            winCount++;
            leaderboard[leaderboard.length - 1].score += winAmount;
        } else {
            // NO GAIN, NO LOSS condition: User bet on a non-winning shape
            outcome = 'nogain';

            // Generate a mixed combination of 'cube' and 'cylinder' that is not all the same
            const baseCombo = Math.random() < 0.5 ? ['cube', 'cube', 'cylinder'] : ['cylinder', 'cylinder', 'cube'];
            // Shuffle the array to randomize positions
            combo = baseCombo.sort(() => Math.random() - 0.5);

            wallet += betAmount; // Return the bet

            message = `<span class="nogain">No gain, no loss. Your bet is returned.</span>`;
            isReward = 0;
            thumbsDown();
        }

        renderReels(combo);
        document.getElementById('gameMessage').innerHTML = message;
        document.getElementById('totalWinnings').innerText = `Total Winnings: $${totalWinnings}`;
        document.getElementById('walletDisplay').innerText = `Wallet: $${wallet}`;
        let shapeWin = winningShapes.includes(betShape);

        participant.trials.push({
            trial: trialNum + 1,
            bet: betAmount,
            betShape: betShape,
            shapeWin: shapeWin,
            combo: combo.join(','),
            outcome: outcome,
            win: winAmount,
            totalWinnings: totalWinnings,
            wallet: wallet,
            response: combo.join(','),
            isReward: isReward,
            reactionTime: Date.now() - spinStart,
            latency: Date.now() - spinStart
        });

        renderLeaderboard();
        trialNum++;

        if (trialNum < 50 && wallet > 0) {
            setTimeout(() => {
                document.getElementById('reels').classList.remove('sparkle');
                updateGameUI();
                renderLeaderboard();
            }, 1600);
        } else {
            setTimeout(() => {
                participant.timestamps.slotMachineEnd = new Date().toISOString();
                hideAllTasks();
                showAffectiveForm();
            }, 1600);
        }
    }, 1500);
}

function skipGame() {
    participant.timestamps.slotMachineEnd = new Date().toISOString();
    hideAllTasks();
    showAffectiveForm();
}


// 6. Emotional Valence/Arousal Task
function showAffectiveForm() {
  participant.timestamps.affectiveTaskStart = new Date().toISOString();
  hideAllTasks();
  document.getElementById('affectiveForm').classList.remove('hidden');
  participant.affective = {start: Date.now(), valence: 5, arousal: 5, end: null, reactionTime: null}; // Initialize with default values
}
function handleAffectiveForm(event) {
  event.preventDefault();
  participant.affective.valence = Number(document.getElementById('valenceSlider').value);
  participant.affective.arousal = Number(document.getElementById('arousalSlider').value);
  participant.affective.end = Date.now();
  participant.affective.reactionTime = participant.affective.end - participant.affective.start;
  participant.timestamps.affectiveTaskEnd = new Date().toISOString();
  hideAllTasks();
  showMemoryTasks();
}
function skipAffectiveForm() {
  participant.timestamps.affectiveTaskEnd = new Date().toISOString();
   // Record default values if skipped
  participant.affective = {start: participant.affective.start, valence: 5, arousal: 5, end: Date.now(), reactionTime: Date.now() - participant.affective.start};
  hideAllTasks();
  showMemoryTasks();
}


// 7. Memory & Contingency Task
function showMemoryTasks() {
  participant.timestamps.memoryContingencyStart = new Date().toISOString();
  hideAllTasks();
  document.getElementById('memoryForm').classList.remove('hidden');
  renderMemorySymbols();
  renderContingencySymbols();
  participant.memory = {responses: [], scores: [], start: Date.now(), end: null, reactionTime: null};
  participant.contingency = {responses: [], scores: [], start: Date.now(), end: null, reactionTime: null};
}
function handleMemoryForm(event) {
  event.preventDefault();
  const memDivs = document.getElementById('memorySymbolsList').querySelectorAll('.symbol-opt.selected');
  const memResponses = Array.from(memDivs).map(div => [...allSymbols, ...distractorSymbols][Array.from(div.parentNode.children).indexOf(div)]);
  participant.memory.responses = memResponses;
  participant.memory.scores = memResponses.map(sym => allSymbols.includes(sym) ? 1 : 0);
  participant.memory.end = Date.now();
  participant.memory.reactionTime = participant.memory.end - participant.memory.start;

  const contDivs = document.getElementById('contingencySymbolsList').querySelectorAll('.symbol-opt.selected');
  const contResponses = Array.from(contDivs).map(div => [...allSymbols, ...distractorSymbols][Array.from(div.parentNode.children).indexOf(div)]);
  participant.contingency.responses = contResponses;
  participant.contingency.scores = contResponses.map(sym => rewardSymbols.includes(sym) ? 1 : 0);
  participant.contingency.end = Date.now();
  participant.contingency.reactionTime = participant.contingency.end - participant.contingency.start;

  participant.timestamps.memoryContingencyEnd = new Date().toISOString();
  hideAllTasks();
  showProbeTask();
}
function skipMemoryForm() {
  participant.timestamps.memoryContingencyEnd = new Date().toISOString();
  // Record empty responses if skipped
  participant.memory = {responses: [], scores: [], start: participant.memory.start, end: Date.now(), reactionTime: Date.now() - participant.memory.start};
  participant.contingency = {responses: [], scores: [], start: participant.contingency.start, end: Date.now(), reactionTime: Date.now() - participant.contingency.start};
  hideAllTasks();
  showProbeTask();
}
function renderMemorySymbols() {
  const list = document.getElementById('memorySymbolsList');
  list.innerHTML = '';
  [...allSymbols, ...distractorSymbols].forEach(sym => {
    const div = document.createElement('div');
    div.className = 'symbol-opt';
    div.innerHTML = shapeSVGs[sym] || '';
    div.onclick = function() {
      div.classList.toggle('selected');
    };
    list.appendChild(div);
  });
}
function renderContingencySymbols() {
  const list = document.getElementById('contingencySymbolsList');
  list.innerHTML = '';
  [...allSymbols, ...distractorSymbols].forEach(sym => {
    const div = document.createElement('div');
    div.className = 'symbol-opt';
    div.innerHTML = shapeSVGs[sym] || '';
    div.onclick = function() {
      div.classList.toggle('selected');
    };
    list.appendChild(div);
  });
}

// 8. Binary Probe Task
function showProbeTask() {
  participant.timestamps.probeTaskStart = new Date().toISOString();
  hideAllTasks();
  document.getElementById('probeTask').classList.remove('hidden');
  const pairs = [];
  winningCombos.forEach(win => {
    nogainCombos.forEach(nogain => {
      pairs.push([win[0], nogain[0]]);
    });
  });
  let probeIndex = 0;
  participant.probe = [];
  const probeDiv = document.getElementById('probePairs');
  function renderProbe() {
    probeDiv.innerHTML = '';
    if (probeIndex >= pairs.length) {
      document.getElementById('finishBtn').disabled = false;
      return;
    }
    let [a, b] = pairs[probeIndex];
    if (Math.random() > 0.5) [a, b] = [b, a];
    const question = document.createElement('div');
    question.style.fontWeight = 'bold';
    question.style.marginBottom = '12px';
    question.innerText = "Which is more pleasant out of these two?";
    probeDiv.appendChild(question);

    const pairDiv = document.createElement('div');
    pairDiv.className = 'probe-pair';
    const btnA = document.createElement('button');
    btnA.className = 'probe-btn';
    btnA.innerHTML = shapeSVGs[a];
    const btnB = document.createElement('button');
    btnB.className = 'probe-btn';
    btnB.innerHTML = shapeSVGs[b];
    let probeStart = Date.now();
    btnA.onclick = (e) => { e.preventDefault(); recordProbe(a,b,a,probeStart); renderProbe(); };
    btnB.onclick = (e) => { e.preventDefault(); recordProbe(a,b,b,probeStart); renderProbe(); };
    pairDiv.appendChild(btnA);
    pairDiv.appendChild(btnB);
    probeDiv.appendChild(pairDiv);
  }
  function recordProbe(a,b,choice, probeStart) {
    let isReward = rewardSymbols.includes(choice) ? 1 : 0;
    participant.probe.push({
      pair: [a,b],
      choice: choice,
      isReward: isReward,
      reactionTime: Date.now() - probeStart
    });
    probeIndex++;
  }
  renderProbe(); // Initial render

}
function skipProbeTask() {
  participant.timestamps.probeTaskEnd = new Date().toISOString();
  // Record empty probe data if skipped
  participant.probe = [];
  hideAllTasks();
  finishExperiment();
}

// 9. Finish Experiment
function finishExperiment() {
  participant.timestamps.probeTaskEnd = participant.timestamps.probeTaskEnd || new Date().toISOString(); // Capture timestamp if not already
  participant.timestamps.experimentEnd = new Date().toISOString();
  hideAllTasks();
  document.getElementById('thankYou').classList.remove('hidden');

  // Trigger download
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(participant, null, 2)); // Prettify JSON
  const dlAnchor = document.createElement('a');
  dlAnchor.setAttribute("href", dataStr);
  const fileName = `participant_${participant.participantId}_session_${participant.sessionId}_data.json`;
  dlAnchor.setAttribute("download", fileName);
  dlAnchor.click(); // Trigger the download
  dlAnchor.remove();

  console.log('Participant Data:', participant);
}

// DOMContentLoaded: Attach Handlers and Set Initial State
document.addEventListener('DOMContentLoaded', function() {
  // Show only consent form at the beginning
  hideAllTasks();
  document.getElementById('consentForm').classList.remove('hidden');

  // Attach form handlers
  document.getElementById('consentForm').onsubmit = function(event) {
    event.preventDefault();
    showParticipantForm();
  };
  document.getElementById('participantForm').onsubmit = function(event) {
    event.preventDefault();
    startBaseline();
  };
  document.getElementById('likedShapesForm').onsubmit = function(event) {
    event.preventDefault();
    validateLikedShapes();
  };

  document.getElementById('affectiveForm').onsubmit = handleAffectiveForm;
  document.getElementById('memoryForm').onsubmit = handleMemoryForm;
  document.getElementById('finishBtn').onclick = function(event) {
    event.preventDefault();
    finishExperiment();
  };
  // Start game button
  document.querySelector('#instructions .submit-btn:not(.skip-btn)').onclick = function(event) {
    event.preventDefault();
    startGame();
  };

  // Attach skip button handlers
  document.getElementById('skipParticipantForm').onclick = function() {
      // Add timestamp for skipping participant info
      if (!participant.timestamps.participantInfoStart) {
         participant.timestamps.participantInfoStart = new Date().toISOString();
      }
      participant.timestamps.participantInfoEnd = new Date().toISOString();
      hideAllTasks();
      showLikedShapes(); // Skip to Liked Shapes
  };

  document.getElementById('skipBaseline').onclick = skipBaseline;
  document.getElementById('skipLikedShapes').onclick = skipLikedShapes;
  document.getElementById('skipInstructions').onclick = skipInstructions;
  document.getElementById('skipAffectiveForm').onclick = skipAffectiveForm;
  document.getElementById('skipMemoryForm').onclick = skipMemoryForm;
  document.getElementById('skipProbeTask').onclick = skipProbeTask;
  document.getElementById('skipGame').onclick = skipGame;

});
</script>
</body>
</html>

